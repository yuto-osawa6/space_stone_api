# version: 2.1
# orbs:
#   ruby: circleci/ruby@1.7.1

# jobs:
#   test:
#     docker:
#       - image: circleci/ruby:2.7.0
#         # environment:
#         #   RAILS_ENV: test
#         #   DB_HOST: 127.0.0.1
#       - image: circleci/mysql:8.0

#     working_directory: ~/space_stone_api

#     steps:
#       - checkout
#       - ruby/install-deps

#       # restore gem from cache
#       # - restore_cache:
#       #     keys:
#       #       - gem-cache-v1-{{ checksum "~/space_stone_api/Gemfile.lock" }}
#       #       - gem-cache-v1-
#       #     working_directory: ~/space_stone_api

#       # gem install
#       # - run:
#       #     command: |
#       #       gem install bundler
#       #       bundle config set path 'vendor/bundle'
#       #       bundle install --jobs=4 --retry=3
#       #     working_directory: ~/space_stone_api

#       # - save_cache:
#       #     key: gem-cache-v1-{{ checksum "~/space_stone_api/Gemfile.lock" }}
#       #     paths:
#       #       - ~/space_stone_api/vendor/bundle
#       #     working_directory: ~/space_stone_api

#       # Database setup
#       # - run:
#       #     command: bundle exec rails db:create
#       #     working_directory: ~/space_stone_api
#       # - run:
#       #     command: bundle exec rails db:migrate
#       #     working_directory: ~/space_stone_api

#       # - run:
#       #     name: create directory to store test results
#       #     command: mkdir /tmp/test-results
#       #     working_directory: ~/space_stone_api

#       # run tests
#       - run:
#           name: RSpec
#           command: |
#             bundle exec rspec $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings) \
#               || (printf "====== RETRYING...\n\n\n"; bundle exec rspec --only-failures)
#           working_directory: ~/space_stone_api
# workflows:
#   version: 2
#   test:
#     jobs:
#       - test:
#           filters:
#             branches:
#               ignore: main

# workflows:
#   version: 2
#   test:
#     jobs:
#       - build
#       - test:
#           requires:
#             - build


version: 2.1

orbs:
  ruby: circleci/ruby@1.7.1
  # node: circleci/node@2

jobs:
  build:
    docker:
      - image: cimg/ruby:2.7.0
      - image: circleci/mysql:8.0
  #   # working_directory: ~/space_stone_api
    steps:
      - checkout
  #     - ruby/install-deps
  test:
    parallelism: 3
    docker:
      - image: cimg/ruby:2.7-0
      - image: circleci/mysql:8.0
        # environment:
        #   POSTGRES_USER: circleci-demo-ruby
        #   POSTGRES_DB: rails_blog_test
        #   POSTGRES_PASSWORD: ""
    # environment:
    #   BUNDLE_JOBS: "3"
    #   BUNDLE_RETRY: "3"
    #   PGHOST: 127.0.0.1
    #   PGUSER: circleci-demo-ruby
    #   PGPASSWORD: ""
    #   RAILS_ENV: test
    steps:
      - checkout
      - ruby/install-deps
      # - run:
      #     name: Wait for DB
      #     command: dockerize -wait tcp://localhost:5432 -timeout 1m
      # - run:
      #     name: Database setup
      #     command: bundle exec rails db:schema:load --trace
      # Run rspec in parallel
      - ruby/rspec-test
      # - ruby/rubocop-check

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build